// --- CONFIGURAÇÃO DA CENA ---
const container = document.getElementById('brain-viewport');
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x0a192f, 0.12);

const camera = new THREE.PerspectiveCamera(35, container.clientWidth / container.clientHeight, 0.1, 1000);
camera.position.z = 8;

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.setPixelRatio(window.devicePixelRatio);
container.appendChild(renderer.domElement);

// --- ILUMINAÇÃO ---
scene.add(new THREE.AmbientLight(0xffffff, 0.3));
const pLight = new THREE.PointLight(0xffffff, 1);
pLight.position.set(5, 5, 10);
scene.add(pLight);

// --- SISTEMA DE PARTÍCULAS (O "RUÍDO" VISUAL) ---
const partGeo = new THREE.BufferGeometry();
const partCount = 1000;
const posArr = new Float32Array(partCount * 3);
for(let i=0; i < partCount * 3; i++) posArr[i] = (Math.random() - 0.5) * 15;
partGeo.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
const partMat = new THREE.PointsMaterial({ size: 0.05, color: 0xffffff, transparent: true, opacity: 0.5 });
const particles = new THREE.Points(partGeo, partMat);
scene.add(particles);

// --- CARREGAMENTO DO CÉREBRO ---
let brain = null;
let modoAtual = 'NORMAL';
let pulseSpeed = 0.002;
let erroAtivo = false;

const loader = new THREE.GLTFLoader();
loader.load('./human-brain.glb', (gltf) => {
    brain = gltf.scene;
    brain.traverse(c => {
        if (c.isMesh) {
            c.material = new THREE.MeshStandardMaterial({
                color: 0x110000, emissive: 0xe30613, emissiveIntensity: 0.8
            });
        }
    });
    scene.add(brain);
}, undefined, (error) => {
    console.error("Mestre, o arquivo .glb não foi encontrado na pasta!", error);
});

// --- FUNÇÃO DE VOZ DO ANTÔNIO ---
function falar(texto) {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(texto);
        const vozes = window.speechSynthesis.getVoices();
        // Força a voz do Antônio
        const antonio = vozes.find(v => v.name.includes('Antonio')) || vozes.find(v => v.lang.includes('pt-BR'));
        if (antonio) msg.voice = antonio;
        window.speechSynthesis.speak(msg);
    }
}

// --- ANIMAÇÃO (O CORAÇÃO DO SITE) ---
function animate() {
    requestAnimationFrame(animate);
    particles.rotation.y += 0.001;
    
    if (brain) {
        brain.rotation.y += 0.004;

        // Efeito de Chacoalho (Ruído Neural)
        if (erroAtivo || modoAtual === 'TDAH') {
            brain.position.x = (Math.random() - 0.5) * 0.05;
            brain.position.y = (Math.random() - 0.5) * 0.05;
        } else {
            brain.position.set(0, 0, 0);
        }
    }
    renderer.render(scene, camera);
}
animate();

// Ajuste de redimensionamento
window.addEventListener('resize', () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
