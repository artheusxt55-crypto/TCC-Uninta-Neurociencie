<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnintaBot - Neural Analytics Ultra</title>
    <style>
        :root { --ia-cyan: #00f2ff; --primary-red: #e30613; --bg-dark: #010409; --panel-bg: rgba(13, 17, 23, 0.95); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'JetBrains Mono', monospace; }
        body { background: var(--bg-dark); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-red); background: #000; z-index: 100; }
        
        #main-viewport { flex: 1; position: relative; display: flex; overflow: hidden; }
        #history-panel { width: 220px; border-right: 1px solid rgba(0, 242, 255, 0.1); background: rgba(0,0,0,0.8); padding: 20px; z-index: 10; }
        #brain-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* ESTILO DO ROBOZINHO (Ajustado para Vídeo) */
        #robot-standby {
            position: absolute;
            top: 12%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            pointer-events: none;
            transition: opacity 0.8s ease-in-out;
            opacity: 1;
        }
        #robot-standby video {
            width: 160px;
            filter: drop-shadow(0 0 15px rgba(227, 6, 19, 0.4));
        }

        #chat-display { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 850px; padding: 25px; background: var(--panel-bg); border-left: 4px solid var(--ia-cyan); color: #ddd; font-size: 14px; max-height: 180px; overflow-y: auto; z-index: 10; box-shadow: 0 10px 40px rgba(0,0,0,0.8); transition: 0.5s; }
        .control-panel { padding: 30px; background: #000; border-top: 1px solid #1a1a1a; z-index: 100; position: relative; }
        .input-box { display: flex; gap: 15px; max-width: 1000px; margin: 0 auto; align-items: center; }
        input { flex: 1; padding: 18px; border-radius: 8px; border: 1px solid #333; background: #050505; color: var(--ia-cyan); outline: none; font-size: 16px; z-index: 110; }
        .btn-analyze { height: 58px; border-radius: 8px; border: none; background: var(--primary-red); color: white; padding: 0 30px; font-weight: 800; cursor: pointer; z-index: 110; transition: 0.3s; }
        #loading-bar { height: 3px; background: var(--ia-cyan); width: 0%; transition: 0.4s; position: absolute; bottom: 0; left: 0; }
        
        .voice-hub { position: absolute; right: 25px; top: 25px; z-index: 20; display: flex; flex-direction: column; gap: 8px; }
        .voice-card { padding: 10px 18px; font-size: 10px; border: 1px solid var(--ia-cyan); background: rgba(0,0,0,0.8); cursor: pointer; color: var(--ia-cyan); border-radius: 4px; transition: 0.2s; }
        .voice-card.active { background: var(--ia-cyan); color: black; font-weight: bold; box-shadow: 0 0 15px var(--ia-cyan); }
    </style>
</head>
<body>

<header>
    <div style="font-size: 14px; font-weight: 900; letter-spacing: 4px;">UNINTA <span id="status-tag" style="color:var(--primary-red)">NEURAL_ACADEMY</span></div>
    <div style="font-size: 10px; color: var(--ia-cyan)">CORE_V8_FINAL_BUILD</div>
</header>

<div id="main-viewport">
    <aside id="history-panel">
        <div style="font-size: 9px; color: #444; margin-bottom: 15px;">DATABASE_LOGS</div>
        <div id="logs" style="font-size: 10px; color: var(--ia-cyan)">NEURO_LINK: ESTABLISHED</div>
    </aside>

    <div id="robot-standby">
        <video autoplay loop muted playsinline>
            <source src="robo-dormindo.mp4" type="video/mp4">
        </video>
    </div>

    <div class="voice-hub">
        <div id="v-fish" class="voice-card active" onclick="setVoice('fish', this)">FISH_S1_ULTRA</div>
        <div id="v-native" class="voice-card" onclick="setVoice('google', this)">NATIVE_OS</div>
    </div>

    <div id="brain-container"></div>
    <div id="chat-display">>> [SISTEMA]: SINAPSES PRONTAS PARA SCANNER. AGUARDANDO COMANDO...<div id="loading-bar"></div></div>
</div>

<div class="control-panel">
    <div class="input-box">
        <input type="text" id="userInput" placeholder="TDAH, Autismo, Alzheimer, Depressão..." autocomplete="off">
        <button id="btnEnviar" class="btn-analyze">EXECUTAR SCANNER ⚡</button>
    </div>
</div>

<script type="importmap">
    { "imports": { 
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", 
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" 
    } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const GROQ_API = "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";
    const HF_TOKEN = "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"; 

    const input = document.getElementById('userInput');
    const display = document.getElementById('chat-display');
    const bar = document.getElementById('loading-bar');
    const statusTag = document.getElementById('status-tag');
    const robot = document.getElementById('robot-standby');

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('brain-container').appendChild(renderer.domElement);
    camera.position.z = 7;

    const partMat = new THREE.PointsMaterial({ size: 0.025, color: 0x00f2ff, transparent: true, opacity: 0.7 });
    let brain, targetZ = 7, currentZ = 7, isAnalyzing = false;

    // SISTEMA DE PARTÍCULAS (ESTRELAS)
    const partCount = 2000;
    const partGeo = new THREE.BufferGeometry();
    const posArray = new Float32Array(partCount * 3);
    for(let i=0; i<partCount*3; i++) posArray[i] = (Math.random() - 0.5) * 12;
    partGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    const particles = new THREE.Points(partGeo, partMat);
    scene.add(particles);

    // CARREGAR CÉREBRO UNINTA
    new GLTFLoader().load('./brainunt.glb', (gltf) => {
        brain = gltf.scene;
        brain.scale.set(2.2, 2.2, 2.2);
        brain.traverse((node) => {
            if (node.isMesh) {
                node.material = new THREE.MeshStandardMaterial({
                    color: 0x00f2ff,
                    emissive: 0x00f2ff,
                    emissiveIntensity: 0.5,
                    wireframe: true 
                });
            }
        });
        scene.add(brain);
    });

    function animate(time) {
        requestAnimationFrame(animate);
        const elapsed = time * 0.001;
        if(brain) {
            brain.rotation.y += 0.006;
            brain.position.y = Math.sin(elapsed * 1.5) * 0.15;
        }
        particles.rotation.y += 0.0015;
        currentZ += (targetZ - currentZ) * 0.08;
        camera.position.z = currentZ;
        renderer.render(scene, camera);
    }
    animate(0);

    window.currentVoice = 'fish';
    window.setVoice = (mode, el) => {
        window.currentVoice = mode;
        document.querySelectorAll('.voice-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    };

    function triggerNeuralVisuals(color, label) {
        statusTag.innerText = label;
        statusTag.style.color = color;
        partMat.color.set(color);
        display.style.borderColor = color;
        
        if(brain) {
            brain.traverse((node) => {
                if (node.isMesh) {
                    node.material.color.set(color);
                    node.material.emissive.set(color);
                }
            });
        }

        targetZ = 4.8;
        setTimeout(() => {
            targetZ = 7;
            if(brain) {
                brain.traverse((node) => {
                    if (node.isMesh) {
                        node.material.color.set(0x00f2ff);
                        node.material.emissive.set(0x00f2ff);
                    }
                });
            }
        }, 5000);
    }

    async function enviar() {
        const txt = input.value.trim();
        const low = txt.toLowerCase();
        if(!txt || isAnalyzing) return;

        isAnalyzing = true;
        input.disabled = true;
        robot.style.opacity = "0"; // Robo some durante o scan
        bar.style.width = "50%";

        if(low.includes('tdah')) triggerNeuralVisuals('#ffcc00', 'DOPAMINE_SCAN');
        else if(low.includes('autismo') || low.includes('tea')) triggerNeuralVisuals('#0055ff', 'CONNECTIVITY_MAP');
        else if(low.includes('alzheimer')) triggerNeuralVisuals('#00ff00', 'NEURO_DEGENERATION');
        else if(low.includes('depressao')) triggerNeuralVisuals('#8000ff', 'SEROTONIN_INDEX');
        else triggerNeuralVisuals('#e30613', 'NEURAL_ACADEMY');

        try {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${GROQ_API}`, "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    model: "llama-3.3-70b-versatile", 
                    messages: [
                        {role: "system", content: "Você é o UnintaBot, ferramenta de pesquisa avançada em Neurociência da Uninta Tianguá. Sua personalidade é técnica (USP/UFRGS). Fale sobre Psicopatologia e Neuroimagem."}, 
                        {role: "user", content: txt}
                    ] 
                })
            });

            const data = await res.json();
            const resp = data.choices[0].message.content;
            bar.style.width = "100%";
            display.innerHTML = `>> [ANÁLISE]: ${resp}`;
            
            const cleanText = resp.replace(/[*#]/g, '');
            if(window.currentVoice === 'fish') {
                const success = await tryFishAudio(cleanText);
                if(!success) nativeSpeak(cleanText);
            } else {
                nativeSpeak(cleanText);
            }

        } catch(e) { 
            display.innerHTML = ">> [ERRO]: FALHA NA CONEXÃO NEURAL."; 
        } finally {
            setTimeout(() => { 
                isAnalyzing = false; 
                input.disabled = false; 
                input.value = ""; 
                input.focus(); 
                bar.style.width = "0%"; 
                robot.style.opacity = "1"; // Robo volta no standby
            }, 1000);
        }
    }

    async function tryFishAudio(t) {
        try {
            const response = await fetch("https://fishaudio-openaudio-s1-mini.hf.space/gradio_api/call/predict", {
                method: "POST",
                headers: { "Authorization": `Bearer ${HF_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({ data: [t, "default", null, "", 1
