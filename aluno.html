<script>
    const GROQ_API = "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";
    
    // Lista de chaves que você coletou hoje
    const ELEVEN_KEYS = [
        "sk_d0b906958918700618586bcf7cafebd289f1c5294ee5d4d8",
        "sk_594271fe1a01322e80b2a55bfbdeb7d5df83848d89925cc1",
        "sk_0bce0f9d5161c04c57987dc2da0a1f7f8a1b25a769d624ed",
        "sk_02d74209b2459c2625ef02d648c939e4a23e13ab43230c4a",
        "sk_21e683319463f5b8435c1243886cc9d6a5bd0c549c45620a"
    ];

    let currentKeyIndex = 0;
    let currentVoiceMode = 'minimax'; // Pode mudar para 'eleven' se quiser começar por ela
    let synth = window.speechSynthesis;

    function setVoice(mode, el) {
        currentVoiceMode = mode;
        document.querySelectorAll('.voice-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('status-3d').innerText = `[ MODO ${mode.toUpperCase()} ATIVO ]`;
        synth.cancel();
    }

    // NOVA FUNÇÃO: ELEVENLABS COM RODÍZIO AUTOMÁTICO
    async function speakEleven(texto) {
        const VOICE_ID = "pNInz6obpgDQGcFmaJgB"; // Voz do Adam (pode mudar depois)
        
        try {
            const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
                method: "POST",
                headers: {
                    "xi-api-key": ELEVEN_KEYS[currentKeyIndex],
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    text: texto,
                    model_id: "eleven_multilingual_v2",
                    voice_settings: { stability: 0.5, similarity_boost: 0.5 }
                })
            });

            if (response.status === 401 || response.status === 429) {
                console.warn(`Chave ${currentKeyIndex} esgotada. Pulando para a próxima...`);
                currentKeyIndex++;
                if (currentKeyIndex < ELEVEN_KEYS.length) {
                    return speakEleven(texto); // Tenta novamente com a próxima chave
                } else {
                    throw new Error("Todas as chaves ElevenLabs expiraram.");
                }
            }

            const blob = await response.blob();
            const audio = new Audio(URL.createObjectURL(blob));
            audio.play();
        } catch (e) {
            console.error(e);
            speakLocal(texto, 'emergencia'); // Backup de segurança
        }
    }

    async function speakMiniMax(texto) {
        // ... (sua função minimax original continua igual)
    }

    function speakLocal(texto, mode) {
        synth.cancel();
        const msg = new SpeechSynthesisUtterance(texto);
        msg.lang = 'pt-BR';
        const voices = synth.getVoices();
        
        if (mode === 'antonio') msg.voice = voices.find(v => v.name.includes('Antonio')) || voices[0];
        if (mode === 'baritono') { msg.pitch = 0.4; msg.rate = 0.9; }
        if (mode === 'emergencia') { msg.pitch = 1.8; msg.rate = 1.4; }

        synth.speak(msg);
    }

    async function enviar() {
        const input = document.getElementById('userInput');
        const display = document.getElementById('chat-display');
        const txt = input.value.trim();
        if (!txt) return;

        display.innerText = "Processando Impulsos Neurais...";
        input.value = "";

        try {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${GROQ_API}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "llama-3.3-70b-versatile",
                    messages: [
                        { role: "system", content: "Você é o UnintaBot, especialista em Neurociência, TDAH e Neuroimagem. Respostas diretas e científicas." },
                        { role: "user", content: txt }
                    ]
                })
            });
            const data = await res.json();
            const resp = data.choices[0].message.content;
            display.innerText = "UnintaBot: " + resp;
            
            if (currentVoiceMode === 'eleven') speakEleven(resp);
            else if (currentVoiceMode === 'minimax') speakMiniMax(resp);
            else speakLocal(resp, currentVoiceMode);
        } catch (e) {
            display.innerText = "ERRO NA CONEXÃO NEURAL.";
        }
    }

    // Configuração do Microfone
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (Recognition) {
        const rec = new Recognition();
        rec.lang = 'pt-BR';
        rec.onresult = (e) => { 
            document.getElementById('userInput').value = e.results[0][0].transcript; 
            enviar(); 
        };
        window.ouvir = () => rec.start();
    }
    document.getElementById('userInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') enviar(); });
</script>
